#include "DataPreTreat.h"

int main(int argc, char* argv[])
{
	/************************************** ???????????????? ********************************************/

	const char* Datatreat = "_datatreat";                     //????????????????????????????
	char* InputFileName, * OutputFileName;                      //????????????????????????????????????????????????
	FILE* pInFile, * pOutFile;                                 //????????????????????????????????????????

	int i;
	int iRcdCount = 0;                                        //??????????????????????	

	char szBuf[MAX_BUF_SIZE];                                 //MAX_BUF_SIZE = 512	
	strMyRecord* pRecord;                                     //??????????????????????????????

	list <strMyRecord*> RecordList;                           //????????????????????
	list<strMyRecord*>::iterator RecdIter;                    //????????????????????????????????????

	string strTmp, strTmp2;
	string StrRecord, StrTemp;
	char szSeps[] = ",\r\n";


	//??§Ø??main????????????????????????????
	if (argc != 2)
	{
		cout << "Parameter error !" << endl;
		return -1;
	}

	/********************************* ???????????????????????????? **************************************/
	InputFileName = new char[30];
	strcpy(InputFileName, argv[1]);

	if ((pInFile = fopen(InputFileName, "r")) == NULL)              //kddcup99.data_10000
	{
		cout << "Open training-data file faied !" << endl;
		return -1;
	}

	/********************************* ?????????????????????????? **************************************/
	//??§Õ????????????????????????????????????????????????????????????????????????????????????????_datatreat
	OutputFileName = strcat(InputFileName, Datatreat);

	if ((pOutFile = fopen(OutputFileName, "w")) == NULL)   //kddcup99.data_10000_datatreat
	{
		fclose(pInFile);
		cout << "Creat Data-preterat file failed!" << endl;
		return -1;
	}

	/*********************** ?????????????? ????????????????????,??????????§Û??????************************************
	1??????????????????§Ö????????????????????????????????????
	2????????????????????????????????????????????????????????????????????
	*********************************************************************************************/
	cout << "Start reading records from " << argv[1] << "..." << endl;

	while (fgets(szBuf, MAX_BUF_SIZE, pInFile) != NULL)
	{
		//??????1000 ??????????????????????????
		if (++iRcdCount % 10000 == 0)
			cout << setiosflags(ios::left) << "---------- " << setw(8) << iRcdCount << " lines have read ----------" << endl;

		//????????????????????????
		pRecord = new strMyRecord;

		/********* ??????????????????20??§µ????????§Ñ????????????????????????????????????????????????§Ü??????5???? ***********/

		//????1??§Ó????
		strtok(szBuf, szSeps);

		//????2??§µ??§¿????????????
		strTmp = strtok(NULL, szSeps);
		//????Protocol????????????????????????????¦È????????????????????????
		if (strTmp == "icmp")
			pRecord->iProtocolType = 1;
		else if (strTmp == "tcp")
			pRecord->iProtocolType = 2;
		else if (strTmp == "udp")
			pRecord->iProtocolType = 3;
		else
			pRecord->iProtocolType = 4;


		//????3??§µ??????????????????
		strTmp = strtok(NULL, szSeps);
		//????Service????????????????????????????¦È????????????????????????
		if (strTmp == "domain_u")
			pRecord->iService = 1;
		else if (strTmp == "ecr_i")
			pRecord->iService = 2;
		else if (strTmp == "eco_i")
			pRecord->iService = 3;
		else if (strTmp == "finger")
			pRecord->iService = 4;
		else if (strTmp == "ftp_data")
			pRecord->iService = 5;
		else if (strTmp == "ftp")
			pRecord->iService = 6;
		else if (strTmp == "http")
			pRecord->iService = 7;
		else if (strTmp == "hostnames")
			pRecord->iService = 8;
		else if (strTmp == "imap4")
			pRecord->iService = 9;
		else if (strTmp == "login")
			pRecord->iService = 10;
		else if (strTmp == "mtp")
			pRecord->iService = 11;
		else if (strTmp == "netstat")
			pRecord->iService = 12;
		else if (strTmp == "other")
			pRecord->iService = 13;
		else if (strTmp == "private")
			pRecord->iService = 14;
		else if (strTmp == "smtp")
			pRecord->iService = 15;
		else if (strTmp == "systat")
			pRecord->iService = 16;
		else if (strTmp == "telnet")
			pRecord->iService = 17;
		else if (strTmp == "time")
			pRecord->iService = 18;
		else if (strTmp == "uucp")
			pRecord->iService = 19;
		else
			pRecord->iService = 20;


		//????4??§µ????????????
		strTmp = strtok(NULL, szSeps);
		//????StatusFlag????????????????????????????¦È????????????????????????
		if (strTmp == "REJ")
			pRecord->iStatusFlag = 1;
		else if (strTmp == "RSTO")
			pRecord->iStatusFlag = 2;
		else if (strTmp == "RSTR")
			pRecord->iStatusFlag = 3;
		else if (strTmp == "S0")
			pRecord->iStatusFlag = 4;
		else if (strTmp == "S3")
			pRecord->iStatusFlag = 5;
		else if (strTmp == "SF")
			pRecord->iStatusFlag = 6;
		else if (strTmp == "SH")
			pRecord->iStatusFlag = 7;
		else
			pRecord->iStatusFlag = 8;


		//????5??§µ????????????????????????
		strTmp = strtok(NULL, szSeps);
		pRecord->iSrcBytes = atoi(strTmp.c_str());
		//????6??§µ??????????????????????
		strTmp = strtok(NULL, szSeps);
		pRecord->iDestBytes = atoi(strTmp.c_str());
		//????7????8????9????10??§Ó????
		for (i = 0; i < 4; i++)
			strtok(NULL, szSeps); // 7-10
		//????11??§µ????????????????????
		strTmp = strtok(NULL, szSeps);
		pRecord->iFailedLogins = atoi(strTmp.c_str());
		//????12????13??§Ó????
		strtok(NULL, szSeps); // 12
		strtok(NULL, szSeps); // 13
		//????14??§µ????????????root????????????
		strTmp = strtok(NULL, szSeps);
		pRecord->bRootShell = atoi(strTmp.c_str());
		//????15??§Ó????
		strtok(NULL, szSeps); // 15
		//????16??§µ??root????????????????????????
		strTmp = strtok(NULL, szSeps);
		pRecord->iNumofRoot = atoi(strTmp.c_str());
		//????17????18????19????20????21??§Ó????
		for (i = 0; i < 5; i++)
			strtok(NULL, szSeps); // 17-21 
		//????22??§µ????????????guest????????????
		strTmp = strtok(NULL, szSeps);
		pRecord->bGuestLogin = atoi(strTmp.c_str());
		//????23??§µ??2????????????????????????????????????
		strTmp = strtok(NULL, szSeps);
		pRecord->iCount = atoi(strTmp.c_str());
		//????24??§µ??2??????????????????????????????????
		strTmp = strtok(NULL, szSeps);
		pRecord->iSrvCount = atoi(strTmp.c_str());
		//????25????26??§Ó????
		strtok(NULL, szSeps); // 25
		strtok(NULL, szSeps); // 26
		//????27??§µ??"REJ"??????????????????????????????
		strTmp = strtok(NULL, szSeps);
		//????0~1????§³??????????????????0????100????????????????
		strTmp[1] = strTmp[2];
		strTmp[2] = strTmp[3];
		strTmp[3] = '\0';
		pRecord->iRerrorRate = atoi(strTmp.c_str());

		//????28??§Ó????
		strtok(NULL, szSeps); // 28
		//????29??§µ????????????????????????????????????
		strTmp = strtok(NULL, szSeps);
		strTmp[1] = strTmp[2];
		strTmp[2] = strTmp[3];
		strTmp[3] = '\0';
		pRecord->iSameSrvRate = atoi(strTmp.c_str());


		//????30??§µ????????????????????????????????????
		strTmp = strtok(NULL, szSeps);
		strTmp[1] = strTmp[2];
		strTmp[2] = strTmp[3];
		strTmp[3] = '\0';
		pRecord->iDiffSrvRate = atoi(strTmp.c_str());

		//????31????32??§Ó????
		strtok(NULL, szSeps); // 31
		strtok(NULL, szSeps); // 32
		//????33??§µ????????????????????????????????????????
		strTmp = strtok(NULL, szSeps);
		pRecord->iDstHostSrvCount = atoi(strTmp.c_str());
		//????34??§µ????????????????????????????????????????????????
		strTmp = strtok(NULL, szSeps);
		strTmp[1] = strTmp[2];
		strTmp[2] = strTmp[3];
		strTmp[3] = '\0';
		pRecord->iDstHostSameSrvRate = atoi(strTmp.c_str());


		//????35??§µ??????????????????????????????????????????????
		strTmp = strtok(NULL, szSeps);
		strTmp[1] = strTmp[2];
		strTmp[2] = strTmp[3];
		strTmp[3] = '\0';
		pRecord->iDstHostDiffSrvRate = atoi(strTmp.c_str());

		//????36??§µ????????????????????????????????????????????
		strTmp = strtok(NULL, szSeps);
		strTmp[1] = strTmp[2];
		strTmp[2] = strTmp[3];
		strTmp[3] = '\0';
		pRecord->iDstHostSameSrcPortRate = atoi(strTmp.c_str());

		//????37??§µ??????????????????????????????????????????
		strTmp = strtok(NULL, szSeps);
		strTmp[1] = strTmp[2];
		strTmp[2] = strTmp[3];
		strTmp[3] = '\0';
		pRecord->iDstHostSrvDiffHostRate = atoi(strTmp.c_str());

		//????38??§Ó????
		strtok(NULL, szSeps); // 38
		//????39??§µ??????????????????????????S0????????????????
		strTmp = strtok(NULL, szSeps);
		strTmp[1] = strTmp[2];
		strTmp[2] = strTmp[3];
		strTmp[3] = '\0';
		pRecord->iDstHostSrvSerrorRate = atoi(strTmp.c_str());

		//????40????41??§Ó????
		strtok(NULL, szSeps); // 40
		strtok(NULL, szSeps); // 41
		//????42??§µ?????????????? ??????5????
		strTmp.clear();
		strTmp = strtok(NULL, szSeps);

		if (strTmp == "normal.")
			pRecord->iLabel = 0; //normal
		else if ((strTmp == "smurf.") || (strTmp == "neptune.") || (strTmp == "back.") || (strTmp == "teardrop.") || (strTmp == "pod.") || (strTmp == "land."))
			pRecord->iLabel = 1; //dos
		else if ((strTmp == "satan.") || (strTmp == "ipsweep.") || (strTmp == "portsweep.") || (strTmp == "nmap."))
			pRecord->iLabel = 2; //probe
		else if ((strTmp == "buffer_overflow.") || (strTmp == "rootkit.") || (strTmp == "loadmodule.") || (strTmp == "perl."))
			pRecord->iLabel = 3; //u2r
		else if ((strTmp == "ftp_write.") || (strTmp == "guess_passwd.") || (strTmp == "imap.") || (strTmp == "multihop.") || (strTmp == "phf.") || (strTmp == "spy.") || (strTmp == "warezclient.") || (strTmp == "warezmaster."))
			pRecord->iLabel = 4; //r2l

		//????????????¦Â????????????????
		RecordList.push_back(pRecord);
	}

	//????????????????????????????????????	
	cout << "All Records have read ! Total " << iRcdCount << " records !" << endl;



	/*********************** ?????????????? ??????????????????????????????§Õ???????????????????? ************************************/
	cout << "Start writing records into " << OutputFileName;
	cout << " ..." << endl;

	//??????????????????????????????????????????????????????????§Õ??????????????????????????
	for (i = 0, RecdIter = RecordList.begin(); RecdIter != RecordList.end(); RecdIter++)
	{
		if (++i % 10000 == 0) //&& (IsPrintLog == true))
			cout << setiosflags(ios::left) << "---------- " << setw(8) << i << "lines have written ----------" << endl;

		//????1??§µ????2????????§¿????????????
		StrTemp = intToString(int((*RecdIter)->iProtocolType));
		StrRecord += StrTemp;
		StrRecord += ",";
		//cout<<"Record: "<<StrRecord<<endl;
		StrTemp.clear();

		//????2??§µ????3????????????????????????
		StrTemp = intToString(int((*RecdIter)->iService));
		StrRecord += StrTemp;
		StrRecord += ",";
		//cout<<"Record: "<<StrRecord<<endl;
		StrTemp.clear();

		//????3??§µ????4??????????????????
		StrTemp = intToString(int((*RecdIter)->iStatusFlag));
		StrRecord += StrTemp;
		StrRecord += ",";
		//cout<<"Record: "<<StrRecord<<endl;
		StrTemp.clear();

		//????4??§µ????5??????????????????????????????
		StrTemp = intToString((*RecdIter)->iSrcBytes);
		StrRecord += StrTemp;
		StrRecord += ",";
		//cout<<"Record: "<<StrRecord<<endl;
		StrTemp.clear();

		//????5??§µ????6????????????????????????????
		StrTemp = intToString((*RecdIter)->iDestBytes);
		StrRecord += StrTemp;
		StrRecord += ",";
		//cout<<"Record: "<<StrRecord<<endl;
		StrTemp.clear();

		//????6??§µ????11??????????????????????????
		StrTemp = intToString((*RecdIter)->iFailedLogins);
		StrRecord += StrTemp;
		StrRecord += ",";
		//cout<<"Record: "<<StrRecord<<endl;
		StrTemp.clear();

		//????7??§µ????14??????????????????root????????????
		StrTemp = intToString(int((*RecdIter)->bRootShell));
		StrRecord += StrTemp;
		StrRecord += ",";
		//cout<<"Record: "<<StrRecord<<endl;
		StrTemp.clear();

		//????8??§µ????16????????root????????????????????????
		StrTemp = intToString((*RecdIter)->iNumofRoot);
		StrRecord += StrTemp;
		StrRecord += ",";
		//cout<<"Record: "<<StrRecord<<endl;
		StrTemp.clear();

		//????9??§µ????22??????????????????guest????????????
		StrTemp = intToString(int((*RecdIter)->bGuestLogin));
		StrRecord += StrTemp;
		StrRecord += ",";
		//cout<<"Record: "<<StrRecord<<endl;
		StrTemp.clear();

		//????10??§µ????23????????2????????????????????????????????????
		StrTemp = intToString((*RecdIter)->iCount);
		StrRecord += StrTemp;
		StrRecord += ",";
		//cout<<"Record: "<<StrRecord<<endl;
		StrTemp.clear();

		//????11??§µ????24????????2??????????????????????????????????
		StrTemp = intToString((*RecdIter)->iSrvCount);
		StrRecord += StrTemp;
		StrRecord += ",";
		//cout<<"Record: "<<StrRecord<<endl;
		StrTemp.clear();

		//????12??§µ????27????????"REJ"??????????????????????????????
		StrTemp = intToString(int((*RecdIter)->iRerrorRate));
		StrRecord += StrTemp;
		StrRecord += ",";
		//cout<<"Record: "<<StrRecord<<endl;
		StrTemp.clear();

		//????13??§µ????29??????????????????????????????????????????
		StrTemp = intToString(int((*RecdIter)->iSameSrvRate));
		StrRecord += StrTemp;
		StrRecord += ",";
		//cout<<"Record: "<<StrRecord<<endl;
		StrTemp.clear();

		//????14??§µ????30??????????????????????????????????????????
		StrTemp = intToString(int((*RecdIter)->iDiffSrvRate));
		StrRecord += StrTemp;
		StrRecord += ",";
		//cout<<"Record: "<<StrRecord<<endl;
		StrTemp.clear();

		//????15??§µ????33??????????????????????????????????????????????
		StrTemp = intToString((*RecdIter)->iDstHostSrvCount);
		StrRecord += StrTemp;
		StrRecord += ",";
		//cout<<"Record: "<<StrRecord<<endl;
		StrTemp.clear();

		//????16??§µ????34??????????????????????????????????????????????????????
		StrTemp = intToString(int((*RecdIter)->iDstHostSameSrvRate));
		StrRecord += StrTemp;
		StrRecord += ",";
		//cout<<"Record: "<<StrRecord<<endl;
		StrTemp.clear();

		//????17??§µ????35????????????????????????????????????????????????????
		StrTemp = intToString(int((*RecdIter)->iDstHostDiffSrvRate));
		StrRecord += StrTemp;
		StrRecord += ",";
		//cout<<"Record: "<<StrRecord<<endl;
		StrTemp.clear();

		//????18??§µ????36??????????????????????????????????????????????????
		StrTemp = intToString(int((*RecdIter)->iDstHostSameSrcPortRate));
		StrRecord += StrTemp;
		StrRecord += ",";
		//cout<<"Record: "<<StrRecord<<endl;
		StrTemp.clear();

		//????19??§µ????37????????????????????????????????????????????????
		StrTemp = intToString(int((*RecdIter)->iDstHostSrvDiffHostRate));
		StrRecord += StrTemp;
		StrRecord += ",";
		//cout<<"Record: "<<StrRecord<<endl;
		StrTemp.clear();

		//????20??§µ????39????????????????????????????????S0????????????????
		StrTemp = intToString(int((*RecdIter)->iDstHostSrvSerrorRate));
		StrRecord += StrTemp;
		StrRecord += ",";
		//cout<<"Record: "<<StrRecord<<endl;
		StrTemp.clear();

		//????21??§µ????42???????????????????? ??????5????
		StrTemp = intToString(int((*RecdIter)->iLabel));
		StrRecord += StrTemp;
		//StrRecord += ",";
		//cout<<"Record: "<<StrRecord<<endl;
		StrTemp.clear();

		StrRecord += "\n";
		//cout<<"Record: "<<StrRecord<<endl;

		//??????????§Õ??????????????????????????????
		fputs(StrRecord.c_str(), pOutFile);

		//????StrRecord????????????????
		StrRecord.clear();
	}

	//????????????????????????????????????	
	cout << "All Records have written !" << endl;
}

